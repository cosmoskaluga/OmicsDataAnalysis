# Functional analysis

The main idea of the functional analysis is to connect observed changes in gene expression with associated altered cellular pathways and biological functions. Below we will try the most well-known methods allowing to gain some insight into biological interpretation of the obtained DE results.

## Gene Ontology (GO) analysis

Gene Ontology analysis is probably the most popular and widely-used method.

A one-sided Fisher's exact test (or hypergeometric test) is typically used for over-representation analysis:

```{r}
ego_pbs <- enrichGO(gene = sig_pbs$gene,
                                universe = res_pbs_tb$gene, 
                                keyType = "ENSEMBL",
                                OrgDb = org.Mm.eg.db, 
                                ont = "BP",
                                pAdjustMethod = "BH", 
                                pvalueCutoff = 0.05)

ego_lps <- enrichGO(gene = sig_lps$gene,
                                universe = res_lps_tb$gene, 
                                keyType = "ENSEMBL",
                                OrgDb = org.Mm.eg.db, 
                                ont = "BP",
                                pAdjustMethod = "BH", 
                                pvalueCutoff = 0.05)
```

```{r go_bp, cache = TRUE, fig.width = 10, fig.height = 4.5, fig.align = "center"}
cowplot::plot_grid(barplot(ego_pbs), barplot(ego_lps), nrow = 1)
```

## Pathway analysis

```{r}
ekegg_pbs <- enrichKEGG(gene = na.omit(sig_pbs$ENTREZID),
                    organism = 'mmu',
                    pvalueCutoff = 0.05,
                    universe=na.omit(res_pbs_tb$ENTREZID))

ekegg_lps <- enrichKEGG(gene = na.omit(sig_lps$ENTREZID),
                    organism = 'mmu',
                    pvalueCutoff = 0.05,
                    universe=na.omit(res_lps_tb$ENTREZID))
```

```{r}
library(enrichplot)
```

Since recently, the description of KEGG pathways in the `clusterProfiler` output data include the part related to a species name, which is `- Mus musculus .(house mouse).` in this case. This annoying text complicates visualization of the enriched pathways, so we will get rid of it:

```{r}
ekegg_pbs@result$Description <- sub(" - Mus musculus .(house mouse).", "", ekegg_pbs@result$Description)
ekegg_lps@result$Description <- sub(" - Mus musculus .(house mouse).", "", ekegg_lps@result$Description)
```

Another (and a little bit more complex) way to visualize pathway enrichment results is to use upsetplots, showing co-occurring DE gene sets in respect to the altered pathways they associated with:

```{r}
ups_pbs <- upsetplot(ekegg_pbs)
ups_lps <- upsetplot(ekegg_lps)
```

```{r upset1, cache = TRUE, fig.width = 10, fig.height = 4.5, fig.align = "center"}
ups_pbs
```

```{r upset2, cache = TRUE, fig.width = 10, fig.height = 4.5, fig.align = "center"}
ups_lps
```

## Gene-Set Enrichment Analysis (GSEA)

Unlike hypergeometric distribution based methods, GSEA works in the assumption that even small and not significant, but coordinated changes in gene expression can have impact on cellular pathways. Therefore, GSEA uses statistics of **all** the genes in a dataset, taking log2 Fold Changes as an input.


<img src="docs/images/gsea_enrichment_plot.jpg"/> 

**Figure 3**: The general principle of GSEA. The figure was taken from Subramanian et al., (2005) <https://doi.org/10.1073/pnas.0506580102>

Since GSEA interpretation in `clusterProfiler` rely on NCBI ENTREZ IDs, we will filter out genes not annotated in ENTREZ:

```{r}
pbs_filtered <- filter(res_pbs_tb, ENTREZID != "NA")
lps_filtered <- filter(res_lps_tb, ENTREZID != "NA")
```

Select gene log2(Fold Changes) and assign NCBI ENTREZ IDs as names of the vectors:

```{r}
foldchanges.pbs <- pbs_filtered$log2FoldChange
names(foldchanges.pbs) <- as.character(pbs_filtered$ENTREZID)

foldchanges.lps <- lps_filtered$log2FoldChange
names(foldchanges.lps) <- as.character(lps_filtered$ENTREZID)
```

Sort fold changes:

```{r}
foldchanges.pbs <- sort(foldchanges.pbs, decreasing = TRUE)
foldchanges.lps <- sort(foldchanges.lps, decreasing = TRUE)
```

Now, we can run `gseKEGG()` function with sorted fold changes as input and using default parameters

```{r}
gseaKEGG.pbs <- gseKEGG(geneList = foldchanges.pbs,              
                    pAdjustMethod = "fdr",
                    organism = "mmu", 
                    nPerm = 2000, 
                    minGSSize = 10, 
                    pvalueCutoff = 0.05, 
                    verbose = FALSE, 
                    seed = TRUE)


gseaKEGG.lps <- gseKEGG(geneList = foldchanges.lps,              
                    pAdjustMethod = "fdr",
                    organism = "mmu", 
                    nPerm = 2000, 
                    minGSSize = 10, 
                    pvalueCutoff = 0.05, 
                    verbose = FALSE, 
                    seed = TRUE)
```

Remove the species name in the pathway description again:

```{r}
gseaKEGG.pbs@result$Description <- sub(" - Mus musculus .(house mouse).", "", gseaKEGG.pbs@result$Description)
gseaKEGG.lps@result$Description <- sub(" - Mus musculus .(house mouse).", "", gseaKEGG.lps@result$Description)
```

Check the results for both comparisons:

```{r}
paged_table(gseaKEGG.pbs@result)
```

```{r}
paged_table(gseaKEGG.lps@result)
```

Apart from the adjusted p-values, enrichment score is another important characteristic of the altered pathways, reflecting the degree of which gene sets are over-represented at the top or at the bottom of the input ranked gene lists. You may find the corresponding values in enrichmentScore column of `gseaKEGG.pbs` and `gseaKEGG.lps` tables.

Below is a GSEA plot for three manually selected enriched pathway from the PBS comparison:

```{r gseaplot2, cache = TRUE, fig.width = 9.5, fig.height = 5.5, fig.align = "center"}
gseaplot2(gseaKEGG.pbs, geneSetID = c(15, 23, 29), pvalue_table = TRUE,
          color = c("#E495A5", "#86B875", "#7DB0DD"), ES_geom = "dot")
```

## Gene Set Enrichment Analysis with mSigDB
In the section above we used GO terms and KEGG pathways to perform enrichment analyses, but sometimes it is needed to compare gene expression changes against other gene sets, such as signatures or markers of the various diseases and biological processes. A possible solution is to use Molecular Signatures Database (mSigDB) represents the curated lists of gene sets, divided in 9 main collections:

* H: Hallmark gene sets

* C1: Positional gene sets

* C2: Curated gene sets

* C3: Motif gene sets

* C4: Computational gene sets

* C5: Gene Ontology gene sets

* C6: Oncogenic signatures gene sets

* C7: Immunologic signatures

* C8: Cell type signatures

In R this database is already available through the `msigdbr` package:
```{r}
library(msigdbr)
```

While mSigDB contains annotated gene sets for many species (you can get a list of them with `msigdbr_show_species()`), we will specify 'mouse' to retrieve mouse-related sets for the Hallmark gene sets:
```{r}
msig_h <- msigdbr(species = "mouse", category = "H")
```

Next, prepare an input reference table for enrichment analysis:
```{r}
msigdbr_t2g <- msig_h %>%
  dplyr::distinct(gs_name, ensembl_gene) %>%
  as.data.frame()
```

This table consist of two columns, one for gene set names (specific terms) and another one for the corresponding ENSEMBL IDs:
```{r}
paged_table(head(msigdbr_t2g))
```
Run the over-presentation analysis on significant genes with prepared term-to-gene table using `enricher()` function:
```{r}
hallmarks.pbs <- enricher(gene = sig_pbs$gene, TERM2GENE = msigdbr_t2g)
hallmarks.lps <- enricher(gene = sig_lps$gene, TERM2GENE = msigdbr_t2g)
```

Visualize the obtained enriched terms for PBS comparison:
```{r hallmarks_pbs, cache = TRUE, fig.width = 7, fig.height = 5.5, fig.align = "center"}
dotplot(hallmarks.pbs)
```

... and for LPS comparison:
```{r hallmarks_lps, cache = TRUE, fig.width = 7, fig.height = 5.5, fig.align = "center"}
dotplot(hallmarks.lps)
```

To run the GSEA analysis with mSigDB terms we must select NCBI ENTREZ IDs instead of ENSEMBL ones:
```{r}
msigdbr_t2g <- msig_h %>%
  dplyr::distinct(gs_name, entrez_gene)
```

Now execute `GSEA` function with `foldchanges.pbs` gene list and re-generated term-to-gene annotation:
```{r}
gsea_h_pbs <- GSEA(foldchanges.pbs, TERM2GENE = msigdbr_t2g)
```

Check out the enriched terms:
```{r}
paged_table(head(gsea_h_pbs))
```
An essential part of DE analysis is the validation of the obtained gene expression changes with custom gene sets, identified by other researches in similar experiments. Here we will use previously described enrichment methods to compare our changes against a list of DAM metabolites.

::: design
**Task 4**: Perform GSEA on `foldchanges.pbs` and `foldchanges.lps` lists using DAM-related genes as an argument for `TERM2GENE = ...` in `GSEA()` function (1.5 point).
:::

